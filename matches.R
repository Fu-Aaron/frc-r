library(tidyverse)
library(stringr)


# Lay out 2017 Events -----------------------------------------------------

events2017 = c(
  "2017abca",
  "2017alhu",
  "2017arc",
  "2017arli",
  "2017aurb",
  "2017ausc",
  "2017ausp",
  "2017azcmp",
  "2017azfl",
  "2017azpx",
  "2017bc",
  "2017cabl",
  "2017cacc",
  "2017cacg",
  "2017cada",
  "2017cair",
  "2017calb",
  "2017cama",
  "2017cars",
  "2017carv",
  "2017casd",
  "2017casf",
  "2017casj",
  "2017cave",
  "2017cc",
  "2017chcmp",
  "2017cmpmo",
  "2017cmptx",
  "2017code",
  "2017crc",
  "2017crc2",
  "2017cthar",
  "2017ctsc",
  "2017ctss",
  "2017cttd",
  "2017ctwat",
  "2017cur",
  "2017dal",
  "2017dar",
  "2017flor",
  "2017flrc",
  "2017flwp",
  "2017gaalb",
  "2017gacmp",
  "2017gacol",
  "2017gadal",
  "2017gagai",
  "2017gagr",
  "2017gal",
  "2017glbbb",
  "2017gush",
  "2017havoc",
  "2017hiho",
  "2017hop",
  "2017iacf",
  "2017idbo",
  "2017ilch",
  "2017ilpe",
  "2017ilrr",
  "2017incm",
  "2017incmp",
  "2017inmis",
  "2017inpmh",
  "2017inwla",
  "2017iri",
  "2017iroc",
  "2017iscmp",
  "2017isde1",
  "2017isde2",
  "2017isde3",
  "2017isde4",
  "2017kscup",
  "2017kybb",
  "2017lake",
  "2017mabos",
  "2017mabri",
  "2017marea",
  "2017mawor",
  "2017mdbb",
  "2017mdbet",
  "2017mdedg",
  "2017mdowi",
  "2017melew",
  "2017mems",
  "2017mesh",
  "2017miann",
  "2017mibb",
  "2017mibro",
  "2017micen",
  "2017micmp",
  "2017micmp1",
  "2017micmp2",
  "2017micmp3",
  "2017micmp4",
  "2017miesc",
  "2017migay",
  "2017migrg",
  "2017migul",
  "2017mihow",
  "2017mike2",
  "2017miken",
  "2017miket",
  "2017mikk",
  "2017milak",
  "2017milan",
  "2017miliv",
  "2017milsu",
  "2017mimar",
  "2017mimid",
  "2017mishe",
  "2017misjo",
  "2017misou",
  "2017mitry",
  "2017mitvc",
  "2017miwat",
  "2017miwmi",
  "2017mncmp",
  "2017mndu",
  "2017mndu2",
  "2017mnemcc",
  "2017mngggt",
  "2017mnmi",
  "2017mnmi2",
  "2017mnmn",
  "2017mnri",
  "2017mokc",
  "2017mosl",
  "2017mrcmp",
  "2017msbbb",
  "2017mttd",
  "2017mvrc",
  "2017mxtl",
  "2017mxto",
  "2017ncash",
  "2017nccmp",
  "2017ncgre",
  "2017ncral",
  "2017ncth",
  "2017ncth2",
  "2017ncwin",
  "2017necmp",
  "2017new",
  "2017nhbb",
  "2017nhbed",
  "2017nhfoc",
  "2017nhgrs",
  "2017nhmm",
  "2017nhrr",
  "2017njbe",
  "2017njbri",
  "2017njdd",
  "2017njfla",
  "2017njmm",
  "2017njski",
  "2017njtab",
  "2017nmrcc",
  "2017nvlv",
  "2017nyfs",
  "2017nyhvr",
  "2017nyli",
  "2017nyny",
  "2017nyro",
  "2017nyrr",
  "2017nysu",
  "2017nytr",
  "2017nytv",
  "2017ohcl",
  "2017ohsp",
  "2017okok",
  "2017onbar",
  "2017oncmp",
  "2017onff",
  "2017onham",
  "2017onlon",
  "2017onnob",
  "2017onosh",
  "2017onsc",
  "2017onsi",
  "2017onto1",
  "2017onto2",
  "2017onwat",
  "2017onwin",
  "2017orgg",
  "2017orlak",
  "2017orore",
  "2017orwil",
  "2017paca",
  "2017pagp",
  "2017pahat",
  "2017paphi",
  "2017parr",
  "2017pascs",
  "2017pawch",
  "2017pncmp",
  "2017qcmo",
  "2017ripro",
  "2017roe",
  "2017rsr",
  "2017scmb",
  "2017scriw",
  "2017tes",
  "2017tnkn",
  "2017tur",
  "2017turk",
  "2017txda",
  "2017txho",
  "2017txlu",
  "2017txntx",
  "2017txri",
  "2017txrm",
  "2017txrr",
  "2017txsa",
  "2017txsc",
  "2017txwa",
  "2017txwo",
  "2017utwv",
  "2017vabla",
  "2017vagle",
  "2017vahay",
  "2017vamars",
  "2017vapor",
  "2017varr",
  "2017waahs",
  "2017waamv",
  "2017waell",
  "2017wagg",
  "2017wamou",
  "2017wapp",
  "2017wasno",
  "2017waspo",
  "2017week0",
  "2017wila",
  "2017wimi",
  "2017wiwi",
  "2017wmri",
  "2017wowcmp"
)


# Functions ---------------------------------------------------------------

tryDownloadEvent <- function(event) {
  tryCatch(
    download.file(
      paste(c("https://raw.githubusercontent.com/the-blue-alliance/the-blue-alliance-data/master/events/2017/",
              event,
              "/",
              event,
              "_matches.csv"),
            collapse = ""),
      paste(c("data/",
              event,
              "_matches.csv"),
            collapse = ""),
      "curl"))
}

readEventCSV <- function(event) {
  tryCatch(
    read_csv(
      paste(c("data/",
              event,
              "_matches.csv"),
            collapse = ""),
      col_names = c("match_key",
                    "red1",
                    "red2",
                    "red3",
                    "blue1",
                    "blue2",
                    "blue3",
                    "red_score",
                    "blue_score")))
}


# Script ------------------------------------------------------------------

# Set to TRUE to download files
do_download <- FALSE

output <- vector("list", length(events2017))
for (i in seq_along(events2017)) {
  if (do_download == TRUE) {
    tryDownloadEvent(events2017[[i]])
  }
  tryCatch(output[[i]] <- readEventCSV(events2017[[i]]))
}
matches <- bind_rows(output)


# Plotting ----------------------------------------------------------------

matches %>%
  na.omit() %>%
  gather(red_score, blue_score, key = "alliance", value = "score") %>%
  filter(score >= 0) %>%
  group_by(score) %>%
  count() %>%
  ggplot(aes(score, n)) +
  geom_point() +
  geom_smooth() +
  labs(
    title = "Score distribution across matches",
    subtitle = "Scores are spiky due to 2017 scoring thresholds",
    x = "Score",
    y = "Alliance-Matches"
  )
ggsave("2017_score_distribution.png", height = 4, width = 4)

